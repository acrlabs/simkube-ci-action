---
name: Run Simkube Simulation
description: Runs a simkube simulation on an ephemeral runner

inputs:
  simulation-name:
    description: Name of the simulation to run
    required: true

  trace-path:
    description: Path to the trace file
    required: true

  simulation-duration:
    description: Simulation duration
    required: true

  speed:
    description: Simulation speed
    required: false

runs:
  using: composite
  steps:
    - name: Run simulation
      id: build-cmd
      shell: bash
      env:
        SIMULATION_NAME: ${{ inputs.simulation-name }}
        TRACE_PATH: ${{ inputs.trace-path }}
        DURATION: ${{ inputs.simulation-duration }}
        SPEED: ${{ inputs.speed }}
      run: |
        # Base command
        CMD="skctl run '$SIMULATION_NAME'"

        # Required
        CMD="$CMD --trace-path '$TRACE_PATH'"
        CMD="$CMD --duration '$DURATION'"

        # Add speed if provided
        if [ -n "$SPEED" ]; then
          CMD="$CMD --speed '$SPEED'"
        fi

        echo ""
        echo "Command to execute:"
        echo "$CMD"
        echo ""
        echo "Starting simulation..."
        eval $CMD

    - name: Wait for simulation to start
      shell: bash
      env:
        SIMULATION_NAME: ${{ input.simulation-name }}
      run: |
        echo "Waiting for simulation to reach Running state..."
        kubectl wait --for=condition=Running simulation/"$SIMULATION_NAME"
        echo "✓ Simulation is running!"

    - name: Wait for simulation to complete
      shell: bash
      env:
        SIMULATION_NAME: ${{ inputs.simulation-name }}
      run: |
        echo "Waiting for simulation to complete..."
        kubectl wait --for=condition=Finished simulation/"$SIMULATION_NAME"
        echo "✓ Simulation completed successfully!"

    - name: Display summary
      shell: bash
      env:
        SIMULATION_NAME: ${{ inputs.simulation-name }}
      if: success()
      run: |
        echo ""
        echo "Simulation Completed!"
        echo ""
        echo "Name:          '$SIMULATION_NAME'"
        echo "Completed at:  $(date)"
        echo ""
